<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">


<!-- html generated by pub-server from markdown /021 Web Server Configuration.md -->

<title>Web Server Configuration</title>
<link rel="stylesheet" href="./css/github-markdown.css">
<link rel="stylesheet" href="./css/pub-theme-doc.css">
<link rel="stylesheet" href="./css/prism.css">
<link rel="stylesheet" href="./css/font-awesome.css">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>

<div data-render-layout="main-layout"><header>
<div id="doctitle"><h1 id="pub-server"><a href="./">pub-server</a></h1>
<p>documentation</p>
</div>
<div id="topmenu"><ul>
<li><a href="https://github.com/jldec/pub-server" title="github"><span class="fa fa-lg fa-fw">&#xf09b;</span></a></li>
</ul>
</div>
</header>

<div id="navicon" onclick=""><p><span class="fa fa-fw fa-lg">&#xf0c9;</span></p>

<nav id="toc">
<ul>
<li><a href="./">Introduction</a></li>
<li><a href="./how-it-works">How it works</a></li>
<li><a href="./installation">Installation</a></li>
<li><a href="./simple-doc-site">Simple doc site</a></li>
<li><a href="./configuration">Configuration</a></li>
<li><a href="./packages-and-themes">Packages and Themes</a></li>
<li><a href="./sources">Sources</a></li>
<li><a href="./outputs">Outputs</a></li>
<li><a href="./static-files">Static Files</a></li>
<li><a href="./browser-scripts">Browser Scripts</a></li>
<li><a href="./generator-plugins">Generator Plugins</a></li>
<li><a href="./server-plugins">Server Plugins</a></li>
<li><a href="./web-server-configuration">Web Server Configuration</a></li>
<li><a href="./the-page-model">The Page Model</a></li>
<li><a href="./links">Links</a></li>
<li><a href="./command-line">Command line</a></li>
<li><a href="./helpers">Helpers</a></li>
<li><a href="./github-pages">GitHub Pages</a></li>
</ul>
</nav>
</div>

<div id="main" onclick="">
<div id="content" class="markdown-body">
<div data-render-page="default"><div data-render-html="/web-server-configuration"><h1 id="web-server-configuration">Web Server Configuration</h1>
<p><code>pub-server</code> can be deployed as a node.js Web server with built-in support for:</p>
<ul>
<li>Error handling and redirects</li>
<li>Cookie sessions</li>
<li>User request logging to session memory or redis</li>
<li>System event logging to redis</li>
<li>Access control lists and plugin-support for OAuth</li>
<li>Static and generated files</li>
<li>File-system watchers</li>
<li>Websockets</li>
</ul>
<p>The server is based on <a href="https://expressjs.com/">express</a>.</p>
<h2 id="error-handling">Error handling</h2>
<p><code>pub-server</code> mounts a 404 &#39;not-found&#39; and a 500 &#39;server-error&#39; handler.</p>
<p>The 404 logic will be triggered if no pages, staticPaths, or browserScripts match the requested path. It returns an empty 404 status for requests with a non-html extension.</p>
<p>Not-found requests for paths with no extension, or with an html extension will be 302 redirected to the home page or the first page found, unless there is an explicit /404 page in the content. This results in a much better experience for <code>pub</code> when it is used to render say a directory containing just a single README.md</p>
<p>Server errors will result in a simple empty 500 status response unless there is an explicit /500 page in the content.</p>
<h2 id="sessions">Sessions</h2>
<p>Sessions are automatically enabled. Please refer to  <a href="https://github.com/expressjs/session">express-session</a> for configuration details.</p>
<p>Session options may be maintained in <code>opts.session</code> in <code>pub-config</code>. For details of available options see <a href="https://github.com/expressjs/session#options">express-session</a>. Default values are listed below; a value for <code>session.secret</code> (or <code>process.env.SSC</code>) is required when sessions are persisted in redis.</p>
<pre><code class="language-js">opts<span class="token punctuation">.</span>session <span class="token operator">=</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'pss'</span><span class="token punctuation">,</span>
    resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    saveUninitialized<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    rolling<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    secret<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SSC</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>resisOpts <span class="token operator">&amp;&amp;</span> u<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    cookie<span class="token operator">:</span> <span class="token punctuation">{</span> secure<span class="token operator">:</span>opts<span class="token punctuation">.</span>production<span class="token punctuation">,</span> maxAge<span class="token operator">:</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></pre>
<p>Session storage with with redis is enabled by setting <code>opts.redis</code> in <code>pub-config</code> and, if necessary, configuring the redis credentials via environment variables. See <a href="https://github.com/NodeRedis/node-redis#options-object-properties">node-redis</a> for configuration options.</p>
<pre><code class="language-js">opts<span class="token punctuation">.</span>redis <span class="token operator">=</span>
<span class="token punctuation">{</span> prefix<span class="token operator">:</span> <span class="token string">'pub-test-auth:'</span><span class="token punctuation">,</span> <span class="token comment">// prefix all keys (sessions and logs)</span>
  _sess<span class="token operator">:</span>  <span class="token string">'session:'</span><span class="token punctuation">,</span>       <span class="token comment">// capture sessions using keys &lt;prefix>&lt;_sess>&lt;sid></span>
  _log<span class="token operator">:</span>   <span class="token string">'log:'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>         <span class="token comment">// capture system logs using list key &lt;prefix>&lt;_log> (see below)</span></code></pre>
<p>To configure redis using environment variables:</p>
<pre><code class="language-sh">export RCH=localhost # host: default = localhost, can also be configured via opts.redis.host
export RCP=6379      # port: default = 6379, can also be configured via opts.redis.port
export RCA=xxx       # auth_pass: default blank, can only be configured via environment</code></pre>
<h2 id="system-logs">System logs</h2>
<p>Modules in pub-server call a global &#39;opts.log(...)&#39; provided by <a href="https://github.com/jldec/logger-emitter">logger-emitter</a> to show warnings and errors on the console.</p>
<p>If you set <code>opts.redis._log = &lt;key-name&gt;</code>, the same events will be timestamped and logged into a <a href="https://redis.io/topics/data-types-intro">redis list</a>.</p>
<h2 id="session-logs">Session logs</h2>
<p>pub-server can record clicks and other events generated in the browser via the <code>/server/log/&lt;path&gt;?&lt;params&gt;</code> api.</p>
<p>HTTP requests sent to this endpoint will stored as objects containing the request path and parameters in the <code>session.log</code> and, if redis is enabled, automatically persisted with the session. E.g.</p>
<pre><code class="language-js"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/server/log'</span> <span class="token operator">+</span> location<span class="token punctuation">.</span>pathname <span class="token operator">+</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>search <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> method<span class="token operator">:</span><span class="token string">'POST'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The default <code>/server/log</code> route can be configured by setting &#39;opts.session.logRequestPath&#39;.</p>
<h2 id="configuring-session-based-access-control">Configuring session-based access control</h2>
<p>Access control is configured on the server using environment variables <code>ACL_READ</code>, <code>ACL_EDIT</code>, <code>ACL_ADMIN</code>. These restrict read access to all pages (except those with <code>access:everyone</code>), edit access, and admin access respectively. Editors can also read, and admins can edit and read.</p>
<p>Each of the 3 ACLs contains a comma-separated list of user ids (typically email addresses). These are matched with the <code>session.user</code> at run time, which is established by an authentication plugin such as <a href="https://github.com/jldec/pub-pkg-google-oauth">pub-pkg-google-oauth</a>.</p>
<p>E.g. To grant yourself admin rights, and 3 other users read access:</p>
<pre><code class="language-sh">export ACL_ADMIN={your-email}
export ACL_READ={email-1},{email-2},{email-3}</code></pre>
</div>
</div>
</div>
<div id="credit"><p><span class="fa">&#xf004;</span> powered by <a href="https://jldec.github.io/pub-doc/">pub-server</a> and <a href="https://github.com/jldec/pub-theme-doc">pub-theme-doc</a></p>
</div>
</div>
</div>

<script>window.pubRef = {"href":"/web-server-configuration","relPath":"."};</script>
<script src="./js/jquery-1.12.4.min.js" ></script>
<script src="./pub/pub-ux.js" ></script>
<!-- Copyright (c) 2015-2020 Jürgen Leschner - github.com/jldec - MIT license -->
</body>
</html>
